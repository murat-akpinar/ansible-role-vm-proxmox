# Debian 11 VM
---

- name: Check if VM ID 131 already exists
  shell: qm list | grep -q ' 131 '
  register: vm_exists
  ignore_errors: true
  changed_when: false

- name: Clone VM from template if not exists
  shell: qm clone 452 131 --name debian --full true
  args:
    executable: /bin/bash
  when: vm_exists.rc != 0

- name: Notify VM already exists
  debug:
    msg: "VM ID 131 already exists, skipping clone."
  when: vm_exists.rc == 0

- name: CPU AyarlarÄ±
  shell: "qm set 131 --cores 1 --sockets 2 --memory 2048 --numa 1 --cpu host"
  args:
    executable: /bin/bash

- name: Disk boyutunu ayarla
  shell: "qm resize 131 scsi0 +50G"
  args:
    executable: /bin/bash

- name: Set cloud-init user
  shell: qm set 131 --ciuser "{{ hostvars['proxmox']['cloud_init_user'] }}"
  args:
    executable: /bin/bash

- name: Set cloud-init password
  shell: qm set 131 --cipassword "{{ hostvars['proxmox']['cloud_init_password'] }}"
  args:
    executable: /bin/bash

- name: Set cloud-init IP and gateway configuration
  shell: qm set 131 --ipconfig0 ip="{{ hostvars['proxmox']['cloud_init_ip'] }},gw={{ hostvars['proxmox']['cloud_init_gw'] }}"
  args:
    executable: /bin/bash

- name: Copy SSH public key to Proxmox server under user directory
  copy:
    src: files/ssh_key.pub
    dest: "/root/debian_key.pub"
    owner: root
    group: root
    mode: '0644'

- name: Set SSH public key for the VM using cloud-init
  shell: qm set 131 --sshkey /root/debian_key.pub
  args:
    executable: /bin/bash